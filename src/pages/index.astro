---
import Base from "$lib/layouts/Base.astro";
import Header from "$lib/layouts/partials/Header.astro";
import PrayerCard from "$lib/components/PrayerCard.svelte";
import NewsCard from "$lib/components/NewsCard.svelte";
import Donate from "$lib/components/Donate.svelte";
import JumuaCard from "$lib/components/JumuaCard.svelte";

import getPrayerTimes from "$lib/lib/getPrayerTimes";
import type { PrayerTimeType } from "$lib/types";

// TODO: generate these times dynamically using an api
const times: PrayerTimeType[] = [];
const PRAYER_NAMES = new Set<string>(["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"]);

const { data } = await getPrayerTimes();
const timesArray = Object.keys(data.timings);

const filteredTimes = timesArray.filter((time) => PRAYER_NAMES.has(time));

function formatTime(timeString: string) {
	const [hourString, minute] = timeString.split(":");
	const hour = +hourString % 24;
	return (hour % 12 || 12) + ":" + minute + (hour < 12 ? " AM" : " PM");
}

filteredTimes.forEach((filteredTime, index) => {
	const currentTime = data.timings[filteredTime];

	const previousPrayerTime = data.timings[filteredTimes[index - 1] ?? filteredTimes[index + 5]];
	const nextPrayerTime = data.timings[filteredTimes[index + 1] ?? filteredTimes[index - 5]];

	times.push({
		prayerName: filteredTime,
		prayerTime: formatTime(data.timings[filteredTime]),
		currentPrayerTime: currentTime,
		previousPrayerTime: previousPrayerTime,
		nextPrayerTime: nextPrayerTime
	});
});

const allPosts = await Astro.glob("./posts/*.md");

console.log(allPosts);

type News = {
	postDate: string;
	href: string;
	newsTitle: string;
	newsType: string;
	authorImage: {
		url: string;
		alt: string;
	};
	authorName: string;
};

const news: News[] = [...allPosts.map((post) => ({
	postDate: post.frontmatter.pubDate,
	href: post.url as string,
	authorName: post.frontmatter.author,
	authorImage: post.frontmatter.image,
	newsTitle: post.frontmatter.title,
	newsType: "News"
}))];
---

<Base>
	<Header />
	<main class="mx-auto max-w-[1440px] px-8">
		<div class="py-30">
			<h2 class="mb-4 text-2xl font-semibold">Monday Dec 25th (hijri)</h2>
			<div class="grid grid-cols-1 gap-y-4 md:grid-cols-12 md:gap-x-4">
				<PrayerCard prayerTimes={times} />
				<JumuaCard time="12:40" />
			</div>
		</div>
		<div class="py-36">
			<div class="mx-auto mb-8 max-w-screen-sm text-center lg:mb-16">
				<h2
					class="mb-4 text-4xl md:text-5xl lg:text-6xl font-extrabold tracking-tight text-black"
				>
					Our Blog
				</h2>
				<p class="font-light text-gray-500 sm:text-xl dark:text-gray-400">
					We use an agile approach to test assumptions and connect with the needs of your audience
					early and often.
				</p>
			</div>
			<div class="grid grid-cols-1 gap-4 md:grid-cols-2">
				{
					news.map((article) => (
						<NewsCard
							{...article}
						/>
					))
				}
			</div>
		</div>
		<div class="py-36">
			<Donate />
		</div>
	</main>
</Base>
